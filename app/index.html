<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>HebeDash</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        {{content-for 'head'}}

        <link rel="stylesheet" href="assets/vendor.css">
        <link rel="stylesheet" href="assets/hebe-dash.css">

        {{content-for 'head-footer'}}
    </head>
    <body>
        {{content-for 'body'}}

        <script src="assets/vendor.js"></script>
        <script src="assets/hebe-dash.js"></script>

        {{content-for 'body-footer'}}
        
        <script>
            var isTouchDevice,
                isisDraggingStoryStory = false,

                $document = $(document),
                $window = $(window),
                $body,

                header = {},
                wrappers = {},
                drawers = {},
                canvas = {},
                stories = {},
                toolbox = {};

            canvas.dimensions = {}; // width & height
            canvas.carousel = {};

            var Wrapper = (function(){

                return {
                    switchToDashboard: function() {

                        wrappers.$dashboard.addClass('-open');
                        wrappers.$gallery.removeClass('-open');
                    },

                    switchToGallery: function() {

                        wrappers.$dashboard.removeClass('-open');
                        wrappers.$gallery.addClass('-open');
                    }
                }
            })();

            var Drawer = (function(){

                var bottomDrawerScrollHack = function() {
                    // Hack to reapply overflow otherwise vertical scroll doesn't work on drawer
                    drawers.$bottom.removeClass('-overflow-y-scroll');
                    setTimeout(function(){
                        drawers.$bottom.addClass('-overflow-y-scroll');
                    }, 500);
                };

                return {
                    openTop: function() {
                        drawers.$top.addClass('-open');
                    },

                    closeTop: function() {
                        drawers.$top.removeClass('-open');
                    },

                    openBottomHalf: function(drawer) {
                        drawers.$bottom.addClass('-open');
                        bottomDrawerScrollHack();
                    },

                    openBottomFull: function() {
                        drawers.$bottom.addClass('-open -full');
                        bottomDrawerScrollHack();
                    },

                    closeBottom: function() {
                        drawers.$bottom.removeClass('-open -full');
                    }
                };
            })();

            var Canvas = (function(){

                var open = function() {
                    canvas.$switcher.addClass('-switching');
                };

                var close = function() {
                    canvas.$switcher.removeClass('-switching');
                };

                var stretch = function() {
                    canvas.carousel.$switcher
                        .css({
                            height: canvas.dimensions.height + 'px'
                        });

                    canvas.carousel.$canvases
                        .css({
                            'width': canvas.dimensions.width + 'px',
                            'height': canvas.dimensions.height + 'px'
                        })
                        .find('.canvas__inner')
                        .css({
                            'width': canvas.dimensions.width + 'px',
                            'height': canvas.dimensions.height + 'px'
                        })
                        .style('height', canvas.dimensions.height + 'px', 'important');
                };

                var setupFooter = function(){
                    canvas.carousel.$pageXofY.find('.pg-of__y').text(canvas.carousel.slideCount);

                    // Generate pagination, which we'll manage ourselves for more control
                    var pagerNumbersArr = [];
                    for (var i = 1; i <= canvas.carousel.slideCount; i++) {
                        var $link = $('<a href="javascript:;"><span></span></a>');
                        if (i == 1) $link.addClass('selected');
                        pagerNumbersArr.push($link);
                    }
                    canvas.carousel.$pagerNumbers.append(pagerNumbersArr);

                    canvas.carousel.$pagerNumbers
                        .on('mousedown', 'a', function(e){
                            e.preventDefault();
                            e.stopPropagation();

                            console.log('number clicked');
                        });
                };

                var initCarousel = function(){

                    setTimeout(function(){

                        canvas.carousel.$list
                            .css({
                                'width': (canvas.dimensions.width * canvas.carousel.$canvases.size()) + 'px',
                                'height': canvas.dimensions.height + 'px'
                            })
                            .children('li')
                            .each(function(){
                                $(this).css({
                                    width: canvas.dimensions.width + 'px'
                                });
                            });

                        canvas.carousel.$list
                            .caroufredsel({
                                circular: false,
                                infinite: false,
                                swipe: {
                                    onTouch: true,
                                    onMouse: true
                                },
                                auto: false,
                                scroll: {
                                    onBefore: function(){
                                        canvas.carousel.$list
                                            .trigger('currentPosition', function(index){
                                                canvas.carousel.$pageXofY.find('.pg-of__x').text((index+1));
                                            });
                                    }
                                },
                                onCreate: function(){
                                    // canvas.carousel.$switcher.toggleClass('-switching');
                                    // canvas.carousel.$footer.toggleClass('-switching');
                                }
                            });

                        setupFooter();
                    }, 0);
                };

                var setupEvents = function() {
                    canvas.carousel.$canvases
                        .on('mousedown', '.js-add-story', function(e){
                            e.preventDefault();

                            Drawer.openBottomHalf();
                            canvas.carousel.$switcher.addClass('-blurred');
                        });
                };

                return {
                    init: function() {

                        setTimeout(function(){

                            canvas.dimensions.width = $window.width();
                            canvas.dimensions.height = $window.height() - header.$header.height();

                            // Now they're available, assign these hooks to global canvas carousel object
                            $.extend(canvas.carousel, {
                                $switcher:     $('.js-canvas-switcher'),
                                $list:         $('.js-canvas-switcher-list'),
                                $footer:       $('.js-canvas-switcher-footer'),
                                $canvases:     $('.js-canvas')
                            });

                            // Now hooks are available, assign child hooks to global canvas carousel object
                            $.extend(canvas.carousel, {
                                $pageXofY:     canvas.carousel.$footer.find('.pg-of'),
                                $pager:        canvas.carousel.$footer.find('.carousel-pager'),
                                slideCount:    canvas.carousel.$list.children('li').size()
                            });
                            $.extend(canvas.carousel, {
                                $pagerNumbers: canvas.carousel.$pager.find('.carousel-pager__numbers')
                            });

                            // Ensure the canvas fits the screen
                            stretch();

                            // Initialise caroufredsel
                            initCarousel();

                            // Setup events
                            setupEvents();
                        }, 0);
                    },

                    stretch: function() {
                        stretch();
                    }
                };
            })();

            var Story = (function(){

                return {
                    init: function() {
                        // Initialize packery
                        setTimeout(function(){
                            stories.$container
                                .packery({
                                    itemSelector: '.story',
                                    columnWidth: 170,
                                    rowHeight: 170
                                });

                            var $itemEls = stories.$allStories.draggable({
                                cursor: 'move',
                                containment: 'body',
                                handle: '.js-cogs',
                                scroll: true,
                                scrollSensitivity: 100,
                                scrollSpeed: 25,
                                zIndex: 4
                            });
                            stories.$container.packery('bindUIDraggableEvents', $itemEls);
                        }, 0);

                        setTimeout(function(){
                            stories.$allStories.each(function(){

                                var thisStory = {
                                    $story: $(this),
                                    carousel: {}
                                };
                                thisStory.carousel.$list = thisStory.$story.find('.js-story-carousel');
                                thisStory.carousel.$slides = thisStory.carousel.$list.children('li');
                                thisStory.$footer = thisStory.carousel.$list.closest('.story__content').find('.story__footer');
                                thisStory.$pageCounter = thisStory.$footer.find('.pg-of');
                                thisStory.$pager = thisStory.$footer.find('.carousel-pager');

                                if (thisStory.carousel.$list.length > 0) {

                                    thisStory.$pageCounter.find('.pg-of__y').text(thisStory.carousel.$slides.size());
                                    
                                    thisStory.carousel.$list.caroufredsel({
                                        prev: {
                                            button: thisStory.$pager.find('.carousel-pager__btn.-prev')
                                        },
                                        pagination: thisStory.$pager.find('.carousel-pager__numbers'),
                                        next: {
                                            button: thisStory.$pager.find('.carousel-pager__btn.-next')
                                        },
                                        swipe: {
                                            onTouch: true,
                                            onMouse: true
                                        },
                                        auto: false,
                                        scroll: {
                                            onBefore: function(){
                                                thisStory.carousel.$list.trigger('currentPosition', function(index){
                                                    thisStory.$pageCounter.find('.pg-of__x').text((index+1));
                                                });
                                            }
                                        }
                                    });
                                }
                            });
                        }, 1000);
                    }
                }
            })();

            var Toolbox = (function(){

                return {
                    init: function() {

                    }
                }
            })();

            var HebeDash = (function() {

                var setupDOM = function() {

                    isTouchDevice = 'ontouchstart' in document.documentElement;

                    // When they become available, assign to global scope
                    $body = $('body');

                    // Header
                    header.$header = $('.js-site-header');
                    header.$btnOpenToolbox = $('.js-open-toolbox');
                    header.$siteNav = $('.js-site-nav');

                    // 'Screens'
                    wrappers.$dashboard = $('.js-dashboard-wrapper');
                    wrappers.$gallery = $('.js-gallery-wrapper');

                    // Drawers
                    drawers.$top = $('.js-top-drawer');
                    drawers.$bottom = $('.js-dashboard-bottom-drawer');

                    // Stories
                    stories.$container = $('.js-stories');
                    stories.$allStories = $('.js-story');
                    stories.$allStoryCogs = $('.js-cogs');
                    //stories.$storyCarousels = $('.js-story-carousel');

                    // Story thumbnails
                    stories.$allThumbList = $('.js-thumb-list');

                    // Meta slide
                    stories.$metaSlide = $('.js-story-meta');

                    // Toolbox
                    toolbox.$toolbox = $('.js-toolbox');
                    toolbox.$btnAddStory = $('.js-add-story');

                    Story.init();

                    //loadCSS(svgCSS);
                };

                var setupEvents = function() {

                    header.$siteNav
                        .on('mousedown', '.js-open-toolbox', function(e){
                            $(this).toggleClass('-selected');

                            canvas.carousel.$switcher.removeClass('-blurred');

                            Drawer.openTop();
                            Drawer.closeBottom();
                        })
                        .on('mousedown', '.js-open-gallery', function(e){

                            Wrapper.switchToGallery();
                        });


                    toolbox.$toolbox
                        .on('mousedown', '.js-toolbox-change-canvas', function(e){
                            e.preventDefault();

                            var $el = $(this);
                            $el.toggleClass('-selected');

                            canvas.carousel.$list
                                .caroufredsel({
                                    circular: false,
                                    infinite: false,
                                    swipe: {
                                        onTouch: true,
                                        onMouse: true
                                    },
                                    auto: false,
                                    scroll: {
                                        onBefore: function(){
                                            canvas.carousel.$list
                                                .trigger('currentPosition', function(index){
                                                    canvas.carousel.$pageXofY.find('.pg-of__x').text((index+1));
                                                });
                                        }
                                    },
                                    onCreate: function(){
                                        canvas.carousel.$switcher.toggleClass('-switching');
                                        canvas.carousel.$footer.toggleClass('-switching');
                                    }
                                });
                        })
                        .on('mousedown', '.js-add-story', function(e){
                            e.preventDefault();

                            var $el = $(this);

                            $el.removeClass('-selected');
                            header.$btnOpenToolbox.removeClass('-selected');
                            canvas.carousel.$switcher.addClass('-blurred');

                            Drawer.closeTop();
                            Drawer.openBottomHalf();
                        });

                    drawers.$bottom
                        .on('mousedown', function(e){
                            $body.removeClass('-top-drawer');
                        })
                        .on('mousedown', '.js-bottom-drawer-button .btn', function(e){
                            e.preventDefault();

                            var $el = $(this);
                            var drawerSection = $el.data('btn-type');

                            Drawer.openBottomFull();
                            drawers.$bottom
                                .removeClass('-bd-show-categories -bd-show-official -bd-show-search')
                                .addClass('-bd-show-' + drawerSection)
                                .find('.btn.-selected').removeClass('-selected');

                            $el.addClass('-selected');
                        })
                        .on('mousedown', '.js-close-bottom-drawer', function(e){
                            e.preventDefault();

                            header.$btnOpenToolbox.removeClass('-selected');
                            toolbox.$btnAddStory.removeClass('-selected');
                            canvas.carousel.$switcher.removeClass('-blurred');

                            Drawer.closeBottom();

                            // Wait for drawer to slide off page before reverting section visibility
                            setTimeout(function() {
                                drawers.$bottom.removeClass('-bd-show-categories -bd-show-official -bd-show-search');
                            }, 300);
                        });

                    stories.$allStoryCogs
                        .on('touchstart mousedown', function(e){
                            isDraggingStory = false;
                        })
                        .on('touchmove mousemove', function(e){
                            isDraggingStory = true;
                        });

                    if (isTouchDevice) {
                        stories.$allStoryCogs
                            .on('touchend', function(e){

                                var $el = $(this);
                                if (! isDraggingStory) {
                                    $el.closest('.story__inner').toggleClass('-flip');
                                }
                            });
                    } else {
                        stories.$allStoryCogs
                            .on('mouseup', function(e){

                                var $el = $(this);
                                if (! isDraggingStory) {
                                    $el.closest('.story__inner').toggleClass('-flip');
                                }
                            });
                    }

                    stories.$allThumbList
                        .on('mousedown', '.thumb', function(e) {
                            e.preventDefault();

                            $body.addClass('-story-meta');
                        });

                    stories.$metaSlide
                        .on('mousedown', '.js-close-story-meta', function(e) {
                            e.preventDefault();

                            $body.removeClass('-story-meta');
                        });

                    wrappers.$gallery
                        .on('mousedown', '.js-gallery-back', function(e){
                            e.preventDefault();

                            Wrapper.switchToDashboard();
                        });

                    $window
                        .resize(function(){
                            Carousel.stretch();
                        });
                };

                function setup() {
                    setupDOM();
                    setupEvents();
                }

                return {
                    init: function () {
                        setup();
                    }
                };
            })();
            Canvas.init();

            $document.bind('ready', HebeDash.init);
        </script>
    </body>
</html>
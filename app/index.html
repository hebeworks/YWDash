<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>HebeDash</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        {{content-for 'head'}}

        <link rel="stylesheet" href="assets/vendor.css">
        <link rel="stylesheet" href="assets/hebe-dash.css">

        {{content-for 'head-footer'}}
    </head>
    <body>
        {{content-for 'body'}}

        <script src="assets/vendor.js"></script>
        <script src="assets/hebe-dash.js"></script>

        {{content-for 'body-footer'}}
        
        <script>
            // Cached jQuery objs
            var $document = $(document),
                $window = $(window),
                $body,
                $header,
                canvas = {};

            canvas.dimensions = {}; // width & height
            canvas.carousel = {};

            var canvas_switcher = (function(){

                var open = function() {
                    canvas.$switcher.addClass('-switching');
                };

                var close = function() {
                    canvas.$switcher.removeClass('-switching');
                };

                var stretch = function() {
                    canvas.carousel.$switcher
                        .css({
                            height: canvas.dimensions.height + 'px'
                        });

                    canvas.carousel.$canvases
                        .css({
                            'width': canvas.dimensions.width + 'px',
                            'height': canvas.dimensions.height + 'px'
                        })
                        .find('.canvas__inner')
                        .css({
                            'width': canvas.dimensions.width + 'px',
                            'height': canvas.dimensions.height + 'px'
                        })
                        .style('height', canvas.dimensions.height + 'px', 'important');
                };

                var setupFooter = function(){
                    canvas.carousel.$pageXofY.find('.pg-of__y').text(canvas.carousel.slideCount);

                    // Generate pagination, which we'll manage ourselves for more control
                    var pagerNumbersArr = [];
                    for (var i = 1; i <= canvas.carousel.slideCount; i++) {
                        var $link = $('<a href="javascript:;"><span></span></a>');
                        if (i == 1) $link.addClass('selected');
                        pagerNumbersArr.push($link);
                    }
                    canvas.carousel.$pagerNumbers.append(pagerNumbersArr);

                    canvas.carousel.$pagerNumbers
                        .on('mousedown', 'a', function(e){
                            e.preventDefault();
                            e.stopPropagation();

                            console.log('number clicked');
                        });
                };

                var initCarousel = function(){

                    setTimeout(function(){

                        canvas.carousel.$list
                            .css({
                                'width': (canvas.dimensions.width * canvas.carousel.$canvases.size()) + 'px',
                                'height': canvas.dimensions.height + 'px'
                            })
                            .children('li')
                            .each(function(){
                                $(this).css({
                                    width: canvas.dimensions.width + 'px'
                                });
                            });

                        /*canvas.carousel.$list
                            .caroufredsel({
                                circular: false,
                                infinite: false,
                                swipe: {
                                    onTouch: true,
                                    onMouse: true
                                },
                                auto: false,
                                scroll: {
                                    onBefore: function(){
                                        canvas.carousel.$list
                                            .trigger('currentPosition', function(index){
                                                canvas.carousel.$pageXofY.find('.pg-of__x').text((index+1));
                                            });
                                    }
                                },
                                onCreate: function(){
                                    // canvas.carousel.$switcher.toggleClass('-switching');
                                    // canvas.carousel.$footer.toggleClass('-switching');
                                }
                            });*/

                        setupFooter();
                    }, 0);
                };

                var setupEvents = function() {
                    canvas.carousel.$canvases
                        .on('mousedown', '.js-add-story', function(e){
                            e.preventDefault();

                            //drawerAction('bottom', 'open');
                            canvas.carousel.$switcher.addClass('-blurred');
                        });
                };

                return {
                    init: function() {

                        setTimeout(function(){

                            canvas.dimensions.width = $window.width();
                            canvas.dimensions.height = $window.height() - $header.height();

                            // Now they're available, assign these hooks to global canvas carousel object
                            $.extend(canvas.carousel, {
                                $switcher:     $('.js-canvas-switcher'),
                                $list:         $('.js-canvas-switcher-list'),
                                $footer:       $('.js-canvas-switcher-footer'),
                                $canvases:     $('.js-canvas')
                            });

                            // Now hooks are available, assign child hooks to global canvas carousel object
                            $.extend(canvas.carousel, {
                                $pageXofY:     canvas.carousel.$footer.find('.pg-of'),
                                $pager:        canvas.carousel.$footer.find('.carousel-pager'),
                                slideCount:    canvas.carousel.$list.children('li').size()
                            });
                            $.extend(canvas.carousel, {
                                $pagerNumbers: canvas.carousel.$pager.find('.carousel-pager__numbers')
                            });

                            // Ensure the canvas fits the screen
                            stretch();

                            // Initialise caroufredsel
                            initCarousel();

                            // Setup events
                            setupEvents();
                        }, 0);
                    },

                    stretch: function() {
                        stretch();
                    }
                };
            })();

            var hebe_dash = (function() {

                function setupDOM() {

                    /*$.get('http://thecitytalking.com/content/?format=json').then(function(data) {
                        console.log(data);
                    });*/

                    // Cached jQuery DOM objs
                    $header = $('.js-site-header');
                    $body = $('body');

                    var $siteNav = $('.js-site-nav'),

                        $dashboardWrapper = $('.js-dashboard-wrapper'),
                        $galleryWrapper = $('.js-gallery-wrapper');

                        $storyContainer = $('.js-stories'),
                        $stories = $('.js-story'),
                        $storyCogs = $('.js-cogs'),
                        $storyCarousels = $('.js-story-carousel'),

                        $dashboardBottomDrawer = $('.js-dashboard-bottom-drawer'),
                        $toolbox = $('.js-toolbox'),
                        $btnOpenToolbox = $('.js-open-toolbox'),
                        $btnAddStory = $('.js-add-story'),
                        $storyMeta = $('.js-story-meta'),
                        $thumbList = $('.js-thumb-list');

                    var isTouchDevice = 'ontouchstart' in document.documentElement;

                    // Functions
                    function drawerAction(drawer, action, extent) {

                        if (typeof drawer !== 'undefined') {

                            var $topDrawer = $('.js-top-drawer');
                            var $bottomDrawer = $('.js-dashboard-bottom-drawer');

                            if (drawer == 'top') {
                                $topDrawer.toggleClass('-open');
                            }
                            else if (drawer == 'bottom' && typeof action !== 'undefined') {

                                if (action == 'open') {
                                    $bottomDrawer.addClass('-open');
                                    if (typeof extent !== 'undefined' && extent == 'full') {
                                        $bottomDrawer.addClass('-full');
                                    }

                                    // Hack to reapply overflow otherwise vertical scroll doesn't work on drawer
                                    $bottomDrawer.removeClass('-overflow-y-scroll');
                                    setTimeout(function(){
                                        $bottomDrawer.addClass('-overflow-y-scroll');
                                    }, 500);
                                }
                                else if (action == 'close') {
                                    $bottomDrawer.removeClass('-open -full');
                                }
                            }
                        }
                    }

                    function switchWrapper(wrapper) {

                        if (typeof wrapper !== 'undefined') {

                            if (wrapper == 'dashboard') {
                                $dashboardWrapper.addClass('-open');
                                $galleryWrapper.removeClass('-open');
                            }
                            else if (wrapper == 'gallery') {
                                $dashboardWrapper.removeClass('-open');
                                $galleryWrapper.addClass('-open');
                            }
                        }
                    }

                    // Event handlers
                    $siteNav
                        .on('mousedown', '.js-open-toolbox', function(e){
                            $(this).toggleClass('-selected');

                            canvas.carousel.$switcher.removeClass('-blurred');

                            drawerAction('top');
                            drawerAction('bottom', 'close');
                        })
                        .on('mousedown', '.js-open-gallery', function(e){

                            switchWrapper('gallery');
                        });


                    $toolbox
                        .on('mousedown', '.js-toolbox-change-canvas', function(e){
                            e.preventDefault();

                            var $el = $(this);
                            $el.toggleClass('-selected');

                            canvas.carousel.$list
                                .caroufredsel({
                                    circular: false,
                                    infinite: false,
                                    swipe: {
                                        onTouch: true,
                                        onMouse: true
                                    },
                                    auto: false,
                                    scroll: {
                                        onBefore: function(){
                                            canvas.carousel.$list
                                                .trigger('currentPosition', function(index){
                                                    canvas.carousel.$pageXofY.find('.pg-of__x').text((index+1));
                                                });
                                        }
                                    },
                                    onCreate: function(){
                                        canvas.carousel.$switcher.toggleClass('-switching');
                                        canvas.carousel.$footer.toggleClass('-switching');
                                    }
                                });
                        })
                        .on('mousedown', '.js-add-story', function(e){
                            e.preventDefault();

                            $(this).removeClass('-selected');
                            $btnOpenToolbox.removeClass('-selected');
                            canvas.carousel.$switcher.addClass('-blurred');

                            drawerAction('top');
                            drawerAction('bottom', 'open');
                        });

                    $dashboardBottomDrawer
                        .on('mousedown', function(e){
                            $body.removeClass('-top-drawer');
                        })
                        .on('mousedown', '.js-bottom-drawer-button .btn', function(e){
                            e.preventDefault();

                            var $el = $(this);
                            var drawerSection = $el.data('btn-type');

                            drawerAction('bottom', 'open', 'full');
                            $dashboardBottomDrawer
                                .removeClass('-bd-show-categories -bd-show-official -bd-show-search')
                                .addClass('-bd-show-' + drawerSection)
                                .find('.btn.-selected').removeClass('-selected');

                            $el.addClass('-selected');
                        })
                        .on('mousedown', '.js-close-bottom-drawer', function(e){
                            e.preventDefault();

                            $btnOpenToolbox.removeClass('-selected');
                            $btnAddStory.removeClass('-selected');
                            canvas.carousel.$switcher.removeClass('-blurred');

                            drawerAction('bottom', 'close');

                            // Wait for drawer to slide off page before reverting section visibility
                            setTimeout(function() {
                                $dashboardBottomDrawer.removeClass('-bd-show-categories -bd-show-official -bd-show-search');
                            }, 300);
                        });

                    $thumbList
                        .on('mousedown', '.thumb', function(e) {
                            e.preventDefault();

                            $body.addClass('-story-meta');
                        });

                    $storyMeta
                        .on('mousedown', '.js-close-story-meta', function(e) {
                            e.preventDefault();

                            $body.removeClass('-story-meta');
                        });

                    $galleryWrapper
                        .on('mousedown', '.js-gallery-back', function(e){
                            e.preventDefault();

                            switchWrapper('dashboard');
                        });

                    // Initialize packery
                    setTimeout(function(){
                        $storyContainer
                            .packery({
                                itemSelector: '.story',
                                columnWidth: 170,
                                rowHeight: 170
                            });

                        var $itemEls = $stories.draggable({
                            cursor: 'move',
                            containment: 'body',
                            handle: '.js-cogs',
                            scroll: true,
                            scrollSensitivity: 100,
                            scrollSpeed: 25,
                            zIndex: 4
                        });
                        $storyContainer.packery('bindUIDraggableEvents', $itemEls);
                    }, 0);

                    var dragging = false;
                    $storyCogs
                        .on('touchstart mousedown', function(e){
                            dragging = false;
                        })
                        .on('touchmove mousemove', function(e){
                            dragging = true;
                        });

                    if (isTouchDevice) {
                        $storyCogs
                            .on('touchend', function(e){

                                var $el = $(this);
                                if (! dragging) {
                                    $el.closest('.story__inner').toggleClass('-flip');
                                }
                            });
                    } else {
                        $storyCogs
                            .on('mouseup', function(e){

                                var $el = $(this);
                                if (! dragging) {
                                    $el.closest('.story__inner').toggleClass('-flip');
                                }
                            });
                    }

                    setTimeout(function(){
                        $stories.each(function(){
                            var $el = $(this).find('.js-story-carousel'),
                                $storyFooter = $el.closest('.story__content').find('.story__footer'),
                                $pageCounter = $storyFooter.find('.pg-of'),
                                $pager = $storyFooter.find('.carousel-pager');

                            if ($el.length > 0) {

                                $pageCounter.find('.pg-of__y').text($el.children('li').size());
                                
                                $el.caroufredsel({
                                    prev: {
                                        button: $pager.find('.carousel-pager__btn.-prev')
                                    },
                                    pagination: $pager.find('.carousel-pager__numbers'),
                                    next: {
                                        button: $pager.find('.carousel-pager__btn.-next')
                                    },
                                    swipe: {
                                        onTouch: true,
                                        onMouse: true
                                    },
                                    auto: false,
                                    scroll: {
                                        onBefore: function(){
                                            $el.trigger('currentPosition', function(index){
                                                $pageCounter.find('.pg-of__x').text((index+1));
                                            });
                                        }
                                    }
                                });
                            }
                        });
                    }, 1000);
                    
                    $window
                        .resize(function(){
                            carousel_switcher.stretch();
                        });

                    //loadCSS(svgCSS);
                }

                function setup() {
                    setupDOM();
                }

                return {
                    init: function () {
                        setup();
                    }
                };
            })();
            hebe_dash.init();
            canvas_switcher.init();

            $document.bind('ready', hebe_dash.init);

        </script>
    </body>
</html>